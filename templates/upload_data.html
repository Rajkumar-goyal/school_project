{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Bulk Data Upload via Excel</h2>
        <p class="text-muted">Upload Excel files to import multiple records at once</p>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload Users (Admins / Teachers)</h5>
            </div>
            <div class="card-body">
                <p class="text-danger"><strong>Note:</strong> Only for Admins/Teachers. Students are auto-created via the 'Upload Students' form.</p>
                <h6>Required Columns:</h6>
                <ul>
                    <li><code>username</code> (unique)</li>
                    <li><code>password</code></li>
                    <li><code>role</code> (admin / teacher)</li>
                    <li><code>name</code></li>
                    <li><code>email</code> (optional)</li>
                </ul>
                <div class="mb-3">
                    <form id="uploadUsersForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="uploadFile('users')">Upload Users</button>
                    <a href="{{ url_for('download_template', template_type='users') }}" class="btn btn-outline-secondary">Download Template</a>
                </div>
                <div id="usersResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload Students</h5>
            </div>
            <div class="card-body">
                <p class="text-info">This will automatically create a user account for each student.</p>
                <h6>Required Columns:</h6>
                <ul>
                    <li><code>full_name</code></li>
                    <li><code>email</code> (unique)</li>
                    <li><code>gender</code> (Male/Female/Other)</li>
                    <li><code>date_of_birth</code> (YYYY-MM-DD)</li>
                    <li><code>class_name</code> (must exist)</li>
                    <li><code>section</code> (must exist)</li>
                    <li><code>roll_number</code></li>
                    <li><code>fathers_name</code></li>
                    <li><code>mothers_name</code></li>
                    <li><code>academic_year</code> (e.g., 2025-2026)</li>
                    <li><code>mobile_number</code> (optional)</li>
                </ul>
                <div class="mb-3">
                    <form id="uploadStudentsForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="uploadFile('students')">Upload Students</button>
                    <a href="{{ url_for('download_template', template_type='students') }}" class="btn btn-outline-secondary">Download Template</a>
                </div>
                <div id="studentsResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload Subjects (Master List)</h5>
            </div>
            <div class="card-body">
                <h6>Required Columns:</h6>
                <ul>
                    <li><code>subject_name</code> (unique)</li>
                    <li><code>subject_code</code> (unique)</li>
                </ul>
                <div class="mb-3">
                    <form id="uploadSubjectsForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="uploadFile('subjects')">Upload Subjects</button>
                    <a href="{{ url_for('download_template', template_type='subjects') }}" class="btn btn-outline-secondary">Download Template</a>
                </div>
                <div id="subjectsResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload Classes</h5>
            </div>
            <div class="card-body">
                <p class="text-info"><strong>Note:</strong> This does not assign subjects. You must edit the class from the 'Manage Classes' page to assign subjects.</p>
                <h6>Required Columns:</h6>
                <ul>
                    <li><code>class_name</code></li>
                    <li><code>section</code></li>
                    <li><code>teacher_username</code> (must exist)</li>
                </ul>
                <div class="mb-3">
                    <form id="uploadClassesForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="uploadFile('classes')">Upload Classes</button>
                    <a href="{{ url_for('download_template', template_type='classes') }}" class="btn btn-outline-secondary">Download Template</a>
                </div>
                <div id="classesResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Upload Results</h5>
            </div>
            <div class="card-body">
                <h6>Required Columns:</h6>
                <ul>
                    <li><code>student_username</code> (must exist)</li>
                    <li><code>subject_code</code> (must exist)</li>
                    <li><code>marks_obtained</code></li>
                    <li><code>total_marks</code></li>
                    <li><code>exam_type</code> (e.g., "Term 1", "Final")</li>
                    <li><code>academic_year</code> (e.g., "2024-2025")</li>
                </ul>
                <div class="mb-3">
                    <form id="uploadResultsForm" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control" accept=".xlsx,.xls" required>
                    </form>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="uploadFile('results')">Upload Results</button>
                    <a href="{{ url_for('download_template', template_type='results') }}" class="btn btn-outline-secondary">Download Template</a>
                </div>
                <div id="resultsResult" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Instructions</h5>
            </div>
            <div class="card-body">
                <p class="text-warning"><strong>Note:</strong> The system will validate all data and skip any rows with errors. Make sure referenced data (like usernames) exists before uploading related records.</p>
                <p class="text-info"><strong>Recommended Order of Operations:</strong></p>
                <ol>
                    <li>Upload Users (Admins/Teachers).</li>
                    <li>Upload Subjects (Master List).</li>
                    <li>Upload Classes (assigns teachers).</li>
                    <li>Go to 'Manage Classes' page to assign subjects to your new classes.</li>
                    <li>Upload Students (this creates their user accounts).</li>
                    <li>Upload Results (referencing the student usernames).</li>
                </ol>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function uploadFile(type) {
    //
    // >>> FIX: Added 'students' to the mappers
    //
    const formIdMap = {
        'users': 'uploadUsersForm',
        'students': 'uploadStudentsForm',
        'subjects': 'uploadSubjectsForm',
        'classes': 'uploadClassesForm',
        'results': 'uploadResultsForm'
    };
    
    const resultDivMap = {
        'users': 'usersResult',
        'students': 'studentsResult',
        'subjects': 'subjectsResult',
        'classes': 'classesResult',
        'results': 'resultsResult'
    };

    const formId = formIdMap[type];
    const resultDiv = resultDivMap[type];
    
    if (!formId) {
        alert('Invalid upload type: ' + type);
        return;
    }

    const form = document.getElementById(formId);
    const formData = new FormData(form);
    
    if (!formData.get('file').name) {
        alert('Please select a file first');
        return;
    }
    
    // Show loading
    document.getElementById(resultDiv).innerHTML = '<div class="alert alert-info">Uploading... Please wait.</div>';
    
    //
    // >>> FIX: The URL is dynamic, so this maps 'students' to '/admin/upload_students'
    //
    fetch(`/admin/upload_${type}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const alertClass = data.success ? 'alert-success' : 'alert-danger';
        // Use <pre> tag to preserve formatting of error messages
        document.getElementById(resultDiv).innerHTML = `<div class="alert ${alertClass}"><pre style="white-space: pre-wrap; word-wrap: break-word;">${data.message}</pre></div>`;
        form.reset();
    })
    .catch(error => {
        document.getElementById(resultDiv).innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}
</script>
{% endblock %}